<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="utf-8"/>
  <title>Virtual Keyboard Test</title>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <link rel="stylesheet" href="../style.css"/>
  <link rel="icon" href="data:,"/>
  <style>
    body {
      /* --keyboard-background: linear-gradient(#e66465, #9198e5);
       --keyboard-background: linear-gradient(white, #cacfd7); */
      /* --box-placeholder-color: red; */
      /* --keycap-height: 24px;
      --keycap-gap: 1px;
      --keycap-font-size: 16px;
      --keycap-shift-font-size: 9px;
      --keyboard-toolbar-font-size: 16px;
      --keycap-small-font-size: 9px;
      --keycap-extra-small-font-size: 9px; */
    }

    math-field,
    textarea {
      margin-top: 1em;
      margin-bottom: 1em;
      min-width: 400px;
    }

    @media not (pointer: coarse) {
      body.is-toggle-hidden math-field::part(virtual-keyboard-toggle) {
        display: none;
      }
    }
  </style>
</head>
<body theme="light">
<header>
  <h1>Virtual Keyboard Test</h1>
  <ul>
    <li><a href="../smoke/">Smoke</a></li>
    <li class="current">
      <a href="../virtual-keyboard/">Virtual Keyboard</a>
    </li>
    <li>
      <a href="../mathfield-states/">States</a>
    </li>
    <li>
      <a href="../prompts/">Prompts</a>
    </li>
  </ul>
</header>
<main>
<!--  <math-field  style="width: 200px" read-only id="mf-1">abc1234567890abc1234567890abc1234567890abc1234567890abc1234567890abc1234567890</math-field>-->
  <math-field style="width: 200px" id="mf-1"></math-field>
  <div class="output" id="latex"></div>
  <div class="output" id="latex-expanded"></div>
  <div class="output" id="latex-without-placeholders"></div>

  <div class="buttonbar">
    <button id="insert-number">Insert number</button>
    <button id="delete-number">Delete number</button>
    <button id="move-left">Move left</button>
    <button id="move-right">Move right</button>

    <button id="scroll-left">scroll left</button>
    <button id="scroll-right">scroll right</button>
    <button id="insert-macros">insert macros</button>

    <button id="focus">Focus</button>
    <button id="clear-all">Clear All</button>

<!--    <button id="show-keyboard">Show Keyboard</button>-->
<!--    <button id="hide-keyboard">Hide Keyboard</button>-->
<!--    <button id="freeze-keyboard">Freeze Keyboard</button>-->
<!--    <button id="unfreeze-keyboard">Unfreeze Keyboard</button>-->
<!--    <button id="custom-keyboard">Custom Keyboard</button>-->
<!--    <button id="default-keyboard">Default Keyboard</button>-->
<!--    <button id="toggle-toggle">Toggle Button</button>-->
  </div>
  <div style="height: 100vh">
    long content
  </div>
</main>

<script type="module">
  const mf = document.getElementById('mf-1');

  mf.macros = {
    ...mf.macros,
    variable: {
      args: 1,
      def: '\\mathbf{#1}',
      isImplicitArg: true
    },
  };
  // mf.inlineShortcuts = {
  //   ...mf.inlineShortcuts,
  //   // This means that typing the inline shortcut
  //   a: '\\variable{a}'
  // };


  mf.addEventListener('input', (ev) => {
    updateContent(mf);
  });

  function updateContent(mf) {
    // console.log('input value: ', mf.value)
    try {
      setHtml('latex', mf.getValue('latex'));
      setHtml('latex-expanded', mf.getValue('latex-expanded'));
      setHtml('latex-without-placeholders', mf.getValue('latex-without-placeholders'));
    } catch (e) {
      console.error('Error converting', e.toString());
    }
  }

  function setHtml(id, text) {
    document.getElementById(id).innerHTML = escapeHtml(text);
  }

  function escapeHtml(string) {
    return String(string).replace(
      /[&<>"'`= /\u200b]/g,
      (s) =>
        ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
          '/': '&#x2F;',
          '`': '&#x60;',
          '=': '&#x3D;',
          '\u200b': '&amp;#zws;',
        }[s] ?? s)
    );
  }


  import {MathfieldElement} from '/dist/mathlive.mjs';

  let keyboardFrozen = false;

  const kbd = window.mathVirtualKeyboard;
  kbd.shiftKeycap = {label: 'Shift'};
  kbd.actionKeycap = {label: 'Continue', class: 'action primary small'};
  kbd.backspaceKeycap = {
    label: 'Backspace',
    class: 'action small hide-shift',
  };
  // kbd.layouts = 'minimalist';
  // kbd.alphabeticLayout = 'dvorak';
  // k.addEventListener('virtual-keyboard-toggle', (ev) =>
  //   console.log('toggling ', ev)
  // );

  kbd.addEventListener('before-virtual-keyboard-toggle', (ev) => {
    if (keyboardFrozen && kbd.visible) ev.preventDefault();
  });

  function getCaretPosition(editableDiv) {
    var caretPos = 0,
      sel, range;
    if (window.getSelection) {
      sel = window.getSelection();
      if (sel.rangeCount) {
        range = sel.getRangeAt(0);
        if (range.commonAncestorContainer.parentNode == editableDiv) {
          caretPos = range.endOffset;
        }
      }
    } else if (document.selection && document.selection.createRange) {
      range = document.selection.createRange();
      if (range.parentElement() == editableDiv) {
        var tempEl = document.createElement("span");
        editableDiv.insertBefore(tempEl, editableDiv.firstChild);
        var tempRange = range.duplicate();
        tempRange.moveToElementText(tempEl);
        tempRange.setEndPoint("EndToEnd", range);
        caretPos = tempRange.text.length;
      }
    }
    return caretPos;
  }


  document
    .getElementById('insert-number')
    .addEventListener('click', (e) => {
      mf.insert('1234', {scrollIntoCaret: true})
      e.preventDefault()
    });
  document
    .getElementById('insert-number')
    .addEventListener('mousedown', (e) => {
      e.preventDefault()
    });


  document
    .getElementById('delete-number')
    .addEventListener('click', (e) => {
      mf.executeCommand(['delete-backward'])
    });
  document
    .getElementById('delete-number')
    .addEventListener('mousedown', (e) => {
      e.preventDefault()
    });


  document
    .getElementById('move-left')
    .addEventListener('click', (e) => {
      mf.executeCommand(['moveToPreviousChar'])
    });
  document
    .getElementById('move-left')
    .addEventListener('mousedown', (e) => {
      e.preventDefault()
    });

  document
    .getElementById('move-right')
    .addEventListener('click', (e) => {
      mf.executeCommand(['moveToNextChar'])
    });
  document
    .getElementById('move-right')
    .addEventListener('mousedown', (e) => {
      e.preventDefault()
    });

  document
    .getElementById('insert-macros')
    .addEventListener('click', (e) => {
      mf.executeCommand(['insert', '12+\\mixfraction{1}{3}{7}+\\frac{13}{2}'])
      // mf.executeCommand(['insert', '\\conversion{#1}'])
    });

  document
    .getElementById('insert-macros')
    .addEventListener('mousedown', (e) => {
      e.preventDefault()
    });

  document
    .getElementById('clear-all')
    .addEventListener('click', (e) => {
      mf.executeCommand('deleteAll')
    });

  document
    .getElementById('clear-all')
    .addEventListener('mousedown', (e) => {
      e.preventDefault()
    });

  document
    .getElementById('scroll-right')
    .addEventListener('click', (e) => {
      mf.executeCommand(['scroll', (mf.getField().getBoundingClientRect().width - 5)])

      console.log(mf.getField().scrollLeft)
      console.log(mf.getField().getBoundingClientRect().width)
      console.log(mf.getField().scrollWidth)
    });



  document
    .getElementById('scroll-left')
    .addEventListener('click', (e) => {
      mf.executeCommand(['scroll', -(mf.getField().getBoundingClientRect().width - 5)])

      console.log(mf.getField().scrollLeft)
      console.log(mf.getField().getBoundingClientRect().width)
      console.log(mf.getField().scrollWidth)
    });

  document
    .getElementById('scroll-left')
    .addEventListener('mousedown', (e) => {
      e.preventDefault()
    });

  document
    .getElementById('focus')
    .addEventListener('click', (e) => {
      mf.focus({preventScroll: true})
    });

  document
    .getElementById('focus')
    .addEventListener('mousedown', (e) => {
      e.preventDefault()
    });

</script>
</body>
</html>
